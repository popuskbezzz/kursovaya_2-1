# GitLab CI для worktime-platform.
# Локальная сборка образов (api, web) и деплой в Docker Swarm без SSH.
# Требование: runner должен иметь доступ к Docker daemon хоста (/var/run/docker.sock).
# Переменные CI/CD (в GitLab или в .env при локальном запуске runner):
# - TRAEFIK_BASIC_AUTH, POSTGRES_*, APP_DATABASE_URL, PGADMIN_* (используются в stack)

stages:
  - build
  - deploy

image: docker:24.0.7

variables:
  STACK_NAME: "worktime"
  # Теги образов: коммит + latest для удобства выката.
  API_IMAGE: "worktime-api"
  WEB_IMAGE: "worktime-web"

# Сборка backend-образа (FastAPI)
build_api:
  stage: build
  tags: ["docker"]  # runner с доступом к docker.sock хоста
  script:
    - export TAG="$CI_COMMIT_SHORT_SHA"
    - docker build -t "$API_IMAGE:$TAG" -t "$API_IMAGE:latest" -f backend/Dockerfile backend
  rules:
    - if: $CI_COMMIT_BRANCH
  artifacts:
    expire_in: 1 day
    when: on_failure
    paths: [".gitlab-ci.yml"]

# Сборка frontend-образа (React/Vite)
build_web:
  stage: build
  tags: ["docker"]
  script:
    - export TAG="$CI_COMMIT_SHORT_SHA"
    - docker build -t "$WEB_IMAGE:$TAG" -t "$WEB_IMAGE:latest" -f frontend/Dockerfile frontend
  rules:
    - if: $CI_COMMIT_BRANCH
  needs: ["build_api"]
  artifacts:
    expire_in: 1 day
    when: on_failure
    paths: [".gitlab-ci.yml"]

# Деплой стека на локальный Swarm (та же машина, где runner).
deploy_stack:
  stage: deploy
  tags: ["docker"]
  script:
    - |
      if [ "$(docker info --format '{{.Swarm.LocalNodeState}}')" != "active" ]; then
        echo "== Init swarm =="
        docker swarm init
      else
        echo "== Swarm already active =="
      fi
    - echo "== Deploy stack $STACK_NAME =="
    - docker stack deploy -c infra/stack-worktime.yml "$STACK_NAME"
    - echo "== Stack list =="
    - docker stack ls
    - echo "== Service list =="
    - docker service ls
    - echo "== Containers =="
    - docker ps
  needs: ["build_api", "build_web"]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: production
    url: http://localhost

# Примечания:
# - Используются локальные образы (без registry), поэтому деплой работает только на машине runner.
# - Runner должен иметь доступ к /var/run/docker.sock хоста.
# - Для воспроизведения в отчёте КР: описать стадии build -> deploy, команды docker stack deploy,
#   и то, как overlay-сети и Traefik используются в стеке (см. infra/stack-worktime.yml).
